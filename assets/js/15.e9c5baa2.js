(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{505:function(t,s,a){"use strict";a.r(s);var e=a(2),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"模型设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模型设计"}},[t._v("#")]),t._v(" 模型设计")]),t._v(" "),a("h3",{attrs:{id:"notify"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#notify"}},[t._v("#")]),t._v(" Notify")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("id          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" primaryKey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 主键")]),t._v("\ncontent     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'text'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 消息的内容")]),t._v("\ntype        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("enum")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 消息的类型，1: 公告 Announce，2: 提醒 Remind，3：信息 Message")]),t._v("\ntarget      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 目标的ID")]),t._v("\ntargetType  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 目标的类型")]),t._v("\naction      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 提醒信息的动作类型")]),t._v("\nsender      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发送者的ID")]),t._v("\ncreatedAt   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'datetime'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("h5",{attrs:{id:"save-remind"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#save-remind"}},[t._v("#")]),t._v(" Save Remind")]),t._v(" "),a("p",[t._v("消息表，我们需要"),a("code",[t._v("target")]),t._v("、"),a("code",[t._v("targetType")]),t._v("字段，来记录该条提醒所关联的对象。而"),a("code",[t._v("action")]),t._v("字段，则记录该条提醒所关联的动作。\n比如消息：「小明喜欢了文章」\n则：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("target "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 文章ID")]),t._v("\ntargetType "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'post'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指明target所属类型是文章")]),t._v("\nsender "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 小明ID")]),t._v("\n")])])]),a("h5",{attrs:{id:"save-announce-and-message"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#save-announce-and-message"}},[t._v("#")]),t._v(" Save Announce and Message")]),t._v(" "),a("p",[t._v("当然，Notify还支持存储公告和信息。它们会用到"),a("code",[t._v("content")]),t._v("字段，而不会用到"),a("code",[t._v("target")]),t._v("、"),a("code",[t._v("targetType")]),t._v("、"),a("code",[t._v("action")]),t._v("字段。")]),t._v(" "),a("h5",{attrs:{id:"usernotify"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#usernotify"}},[t._v("#")]),t._v(" UserNotify")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("id          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" primaryKey"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 主键")]),t._v("\nisRead      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'boolean'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   \nuser        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用户消息所属者")]),t._v("\nnotify      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 关联的Notify")]),t._v("\ncreatedAt   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'datetime'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("p",[t._v("我们用UserNotify来存储用户的消息队列，它关联一则提醒(Notify)的具体内容。\nUserNotify的创建，主要通过两个途径：")]),t._v(" "),a("ol",[a("li",[t._v("遍历订阅(Subscription)表拉取公告(Announce)和提醒(Remind)的时候创建")]),t._v(" "),a("li",[t._v("新建信息(Message)之后，立刻创建。")])]),t._v(" "),a("h5",{attrs:{id:"subscription"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#subscription"}},[t._v("#")]),t._v(" Subscription")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("target      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 目标的ID")]),t._v("\ntargetType  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 目标的类型")]),t._v("\naction      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 订阅动作,如: comment/like/post/update etc.")]),t._v("\nuser        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("，\ncreatedAt   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'datetime'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("p",[t._v("订阅，是从Notify表拉取消息到UserNotify的前提，用户首先订阅了某一个目标的某一个动作，在此之后产生这个目标的这个动作的消息，才会被通知到该用户。\n如：「小明关注了产品A的评论」，数据表现为：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("target"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 产品A的ID")]),t._v("\ntargetType"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'product'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\naction"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'comment'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nuser"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 小明的ID")]),t._v("\n")])])]),a("p",[t._v("这样，产品A下产生的每一条评论，都会产生通知给小明了。")]),t._v(" "),a("h5",{attrs:{id:"subscriptionconfig"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#subscriptionconfig"}},[t._v("#")]),t._v(" SubscriptionConfig")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("action"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'json'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" required"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用户的设置")]),t._v("\nuser"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'integer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("不同用户可能会有不一样的订阅习惯，在这个表中，用户可以统一针对某种动作进行是否订阅的设置。而默认是使用系统提供的默认配置：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("defaultSubscriptionConfig"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'comment'")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 评论")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'like'")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 喜欢")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("在这套模型中，"),a("code",[t._v("targetType")]),t._v("、"),a("code",[t._v("action")]),t._v("是可以根据需求来扩展的，例如我们还可以增加多几个动作的提醒："),a("code",[t._v("hate")]),t._v("被踩、"),a("code",[t._v("update")]),t._v("被更新....诸如此类。")]),t._v(" "),a("h5",{attrs:{id:"配置文件-notifyconfig"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置文件-notifyconfig"}},[t._v("#")]),t._v(" 配置文件 NotifyConfig")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 提醒关联的目标类型")]),t._v("\ntargetType"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  PRODUCT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'product'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 产品")]),t._v("\n  POST    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'post'")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 文章")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 提醒关联的动作")]),t._v("\naction"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  COMMENT   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'comment'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 评论")]),t._v("\n  LIKE      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'like'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 喜欢")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 订阅原因对应订阅事件")]),t._v("\nreasonAction"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'create_product'")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'comment'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'like'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'like_product'")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'comment'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'like_post'")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'comment'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 默认订阅配置")]),t._v("\ndefaultSubscriptionConfig"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'comment'")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 评论")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'like'")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 喜欢")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("h3",{attrs:{id:"服务层-notifyservice"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务层-notifyservice"}},[t._v("#")]),t._v(" 服务层 NotifyService")]),t._v(" "),a("h5",{attrs:{id:"notifyservice拥有以下方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#notifyservice拥有以下方法"}},[t._v("#")]),t._v(" NotifyService拥有以下方法:")]),t._v(" "),a("ul",[a("li",[t._v("createAnnounce(content, sender)")]),t._v(" "),a("li",[t._v("createRemind(target, targetType, action, sender, content)")]),t._v(" "),a("li",[t._v("createMessage(content, sender, receiver)")]),t._v(" "),a("li",[t._v("pullAnnounce(user)")]),t._v(" "),a("li",[t._v("pullRemind(user)")]),t._v(" "),a("li",[t._v("subscribe(user, target, targetType, reason)")]),t._v(" "),a("li",[t._v("cancelSubscription(user, target ,targetType)")]),t._v(" "),a("li",[t._v("getSubscriptionConfig(userID)")]),t._v(" "),a("li",[t._v("updateSubscriptionConfig(userID)")]),t._v(" "),a("li",[t._v("getUserNotify(userID)")]),t._v(" "),a("li",[t._v("read(user, notifyIDs)")])]),t._v(" "),a("h5",{attrs:{id:"各方法的处理逻辑如下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#各方法的处理逻辑如下"}},[t._v("#")]),t._v(" 各方法的处理逻辑如下：")]),t._v(" "),a("h6",{attrs:{id:"createannounce-content-sender"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#createannounce-content-sender"}},[t._v("#")]),t._v(" createAnnounce(content, sender)")]),t._v(" "),a("p",[t._v("往Notify表中插入一条公告记录")]),t._v(" "),a("h6",{attrs:{id:"createremind-target-targettype-action-sender-content"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#createremind-target-targettype-action-sender-content"}},[t._v("#")]),t._v(" createRemind(target, targetType, action, sender, content)")]),t._v(" "),a("p",[t._v("往Notify表中插入一条提醒记录")]),t._v(" "),a("h6",{attrs:{id:"createmessage-content-sender-receiver"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#createmessage-content-sender-receiver"}},[t._v("#")]),t._v(" createMessage(content, sender, receiver)")]),t._v(" "),a("ol",[a("li",[t._v("往Notify表中插入一条信息记录")]),t._v(" "),a("li",[t._v("往UserNotify表中插入一条记录，并关联新建的Notify")])]),t._v(" "),a("h6",{attrs:{id:"pullannounce-user"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pullannounce-user"}},[t._v("#")]),t._v(" pullAnnounce(user)")]),t._v(" "),a("ol",[a("li",[t._v("从UserNotify中获取最近的一条公告信息的创建时间: "),a("code",[t._v("lastTime")])]),t._v(" "),a("li",[t._v("用"),a("code",[t._v("lastTime")]),t._v("作为过滤条件，查询Notify的公告信息")]),t._v(" "),a("li",[t._v("新建UserNotify并关联查询出来的公告信息")])]),t._v(" "),a("h6",{attrs:{id:"pullremind-user"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pullremind-user"}},[t._v("#")]),t._v(" pullRemind(user)")]),t._v(" "),a("ol",[a("li",[t._v("查询用户的订阅表，得到用户的一系列订阅记录")]),t._v(" "),a("li",[t._v("通过每一条的订阅记录的"),a("code",[t._v("target")]),t._v("、"),a("code",[t._v("targetType")]),t._v("、"),a("code",[t._v("action")]),t._v("、"),a("code",[t._v("createdAt")]),t._v("去查询Notify表，获取订阅的Notify记录。（注意订阅时间必须早于提醒创建时间）")]),t._v(" "),a("li",[t._v("查询用户的配置文件SubscriptionConfig，如果没有则使用默认的配置DefaultSubscriptionConfig")]),t._v(" "),a("li",[t._v("使用订阅配置，过滤查询出来的Notify")]),t._v(" "),a("li",[t._v("使用过滤好的Notify作为关联新建UserNotify")])]),t._v(" "),a("h6",{attrs:{id:"subscribe-user-target-targettype-reason"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#subscribe-user-target-targettype-reason"}},[t._v("#")]),t._v(" subscribe(user, target, targetType, reason)")]),t._v(" "),a("ol",[a("li",[t._v("通过"),a("code",[t._v("reason")]),t._v("，查询NotifyConfig，获取对应的动作组:"),a("code",[t._v("actions")])]),t._v(" "),a("li",[t._v("遍历动作组，每一个动作新建一则Subscription记录")])]),t._v(" "),a("h6",{attrs:{id:"cancelsubscription-user-target-targettype"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cancelsubscription-user-target-targettype"}},[t._v("#")]),t._v(" cancelSubscription(user, target ,targetType)")]),t._v(" "),a("p",[t._v("删除"),a("code",[t._v("user")]),t._v("、"),a("code",[t._v("target")]),t._v("、"),a("code",[t._v("targetType")]),t._v("对应的一则或多则记录")]),t._v(" "),a("h6",{attrs:{id:"getsubscriptionconfig-userid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#getsubscriptionconfig-userid"}},[t._v("#")]),t._v(" getSubscriptionConfig(userID)")]),t._v(" "),a("p",[t._v("查询SubscriptionConfig表，获取用户的订阅配置")]),t._v(" "),a("h6",{attrs:{id:"updatesubscriptionconfig-userid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#updatesubscriptionconfig-userid"}},[t._v("#")]),t._v(" updateSubscriptionConfig(userID)")]),t._v(" "),a("p",[t._v("更新用户的SubscriptionConfig记录")]),t._v(" "),a("h6",{attrs:{id:"getusernotify-userid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#getusernotify-userid"}},[t._v("#")]),t._v(" getUserNotify(userID)")]),t._v(" "),a("p",[t._v("获取用户的消息列表")]),t._v(" "),a("h6",{attrs:{id:"read-user-notifyids"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#read-user-notifyids"}},[t._v("#")]),t._v(" read(user, notifyIDs)")]),t._v(" "),a("p",[t._v("更新指定的notify，把isRead属性设置为true")]),t._v(" "),a("h1",{attrs:{id:"时序图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#时序图"}},[t._v("#")]),t._v(" 时序图")]),t._v(" "),a("h3",{attrs:{id:"提醒的订阅、创建、拉取"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#提醒的订阅、创建、拉取"}},[t._v("#")]),t._v(" 提醒的订阅、创建、拉取")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://pan.zealsay.com/20190706164023128000000.jpg",alt:"7970261d218212571d556.jpg"}})]),t._v(" "),a("p",[t._v("我们可以在产品创建之后，调用"),a("code",[t._v("NotifyService.subscribe")]),t._v("方法，\n然后在产品被评论之后调用"),a("code",[t._v("NotifyService.createRemind")]),t._v("方法，\n再就是用户登录系统或者其他的某一个时刻调用"),a("code",[t._v("NotifyService.pullRemind")]),t._v("方法，\n最后在用户查询消息队列的时候调用"),a("code",[t._v("NotifyService.getUserNotify")]),t._v("方法。")]),t._v(" "),a("h3",{attrs:{id:"公告的创建、拉取"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#公告的创建、拉取"}},[t._v("#")]),t._v(" 公告的创建、拉取")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://pan.zealsay.com/20190706164023599000000.jpg",alt:"79702122a2d09bd4ef238.jpg"}})]),t._v(" "),a("p",[t._v("在管理员发送了一则公告的时候，调用"),a("code",[t._v("NotifyService.createAnnounce")]),t._v("方法，\n然后在用户登录系统或者其他的某一个时刻调用"),a("code",[t._v("NotifyService.pullAnnounce")]),t._v("方法，\n最后在用户查询消息队列的时候调用"),a("code",[t._v("NotifyService.getUserNotify")]),t._v("方法。")]),t._v(" "),a("h3",{attrs:{id:"信息的创建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#信息的创建"}},[t._v("#")]),t._v(" 信息的创建")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://pan.zealsay.com/20190706164023661000000.jpg",alt:"79702859cd50888877d67.jpg"}}),t._v("\n信息的创建，只需要直接调用"),a("code",[t._v("NotifyService.createMessage")]),t._v("方法就可以了，\n在下一次用户查询消息队列的时候，就会查询这条信息。")])])}),[],!1,null,null,null);s.default=n.exports}}]);